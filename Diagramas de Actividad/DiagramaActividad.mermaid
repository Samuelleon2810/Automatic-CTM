---
config:
  look: handDrawn
  theme: default
---
flowchart TD
    Start([🎬 Inicio]) --> InsertarTarjeta[/Cliente Inserta Tarjeta/]
    
    InsertarTarjeta --> LeerTarjeta[Leer Datos de Tarjeta]
    
    LeerTarjeta --> ValidarTarjeta{¿Tarjeta Válida?}
    
    ValidarTarjeta -->|No| MostrarErrorTarjeta[Mostrar Error:<br/>Tarjeta Inválida]
    MostrarErrorTarjeta --> ExpulsarTarjeta1[Expulsar Tarjeta]
    ExpulsarTarjeta1 --> Fin1([🔚 Fin])
    
    ValidarTarjeta -->|Sí| SolicitarPassword[Solicitar Contraseña]
    
    SolicitarPassword --> IngresarPassword[/Cliente Ingresa Password/]
    
    IngresarPassword --> ValidarPassword{¿Password<br/>Correcto?}
    
    ValidarPassword -->|No| IncrementarIntentos[Incrementar<br/>Contador Intentos]
    
    IncrementarIntentos --> VerificarIntentos{¿Intentos < 3?}
    
    VerificarIntentos -->|Sí| MostrarErrorPass[Mostrar Error:<br/>Password Incorrecto]
    MostrarErrorPass --> SolicitarPassword
    
    VerificarIntentos -->|No| InvalidarTarjeta[❌ Invalidar Tarjeta<br/>en Sistema]
    InvalidarTarjeta --> RetenerTarjeta[Retener Tarjeta<br/>Físicamente]
    RetenerTarjeta --> NotificarAdmin[Notificar a<br/>Administrador]
    NotificarAdmin --> Fin2([🔚 Fin])
    
    ValidarPassword -->|Sí| MostrarMenu[Mostrar Menú<br/>Principal]
    
    MostrarMenu --> SeleccionarOperacion{Cliente<br/>Selecciona<br/>Operación}
    
    SeleccionarOperacion -->|Retiro| IniciarRetiro[🏁 Iniciar Proceso<br/>de Retiro]
    SeleccionarOperacion -->|Depósito| IniciarDeposito[💰 Iniciar Proceso<br/>de Depósito]
    SeleccionarOperacion -->|Consulta| IniciarConsulta[📊 Iniciar Proceso<br/>de Consulta]
    SeleccionarOperacion -->|Compra| IniciarCompra[🎫 Iniciar Proceso<br/>de Compra]
    SeleccionarOperacion -->|Salir| FinalizarSesion[Finalizar Sesión]
    
    %% FLUJO DE RETIRO DETALLADO
    IniciarRetiro --> VerificarCuentas{¿Cliente tiene<br/>múltiples cuentas?}
    
    VerificarCuentas -->|Sí| MostrarCuentas[Mostrar Lista<br/>de Cuentas]
    MostrarCuentas --> SeleccionarCuenta[/Cliente Selecciona<br/>Cuenta/]
    SeleccionarCuenta --> MostrarOpciones
    
    VerificarCuentas -->|No| MostrarOpciones[Mostrar Opciones<br/>de Montos]
    
    MostrarOpciones --> SeleccionarMonto[/Cliente Selecciona<br/>o Ingresa Monto/]
    
    SeleccionarMonto --> ValidarMonto{¿Monto es<br/>múltiplo de<br/>10,000?}
    
    ValidarMonto -->|No| ErrorMontoInvalido[Error: Monto debe ser<br/>múltiplo de 10,000]
    ErrorMontoInvalido --> MostrarOpciones
    
    ValidarMonto -->|Sí| ConsultarSaldo[Consultar Saldo<br/>en Base de Datos]
    
    ConsultarSaldo --> VerificarSaldo{¿Saldo<br/>Suficiente?}
    
    VerificarSaldo -->|No| ErrorSaldoInsuficiente[❌ Error:<br/>Saldo Insuficiente]
    ErrorSaldoInsuficiente --> MostrarSaldoDisp[Mostrar Saldo<br/>Disponible]
    MostrarSaldoDisp --> OpcionReintentar{¿Desea<br/>Reintentar?}
    OpcionReintentar -->|Sí| MostrarOpciones
    OpcionReintentar -->|No| MostrarMenu
    
    VerificarSaldo -->|Sí| ConsultarLimite[Consultar Límite<br/>Diario]
    
    ConsultarLimite --> CalcularDisponible[Calcular Límite<br/>Disponible del Día]
    
    CalcularDisponible --> VerificarLimite{¿Monto dentro<br/>del límite?}
    
    VerificarLimite -->|No| ErrorLimiteExcedido[❌ Error:<br/>Límite Diario Excedido]
    ErrorLimiteExcedido --> MostrarLimiteDisp[Mostrar Límite<br/>Disponible]
    MostrarLimiteDisp --> OpcionReintentar
    
    VerificarLimite -->|Sí| MostrarResumen[Mostrar Resumen<br/>de Transacción]
    
    MostrarResumen --> SolicitarConfirmacion[/Solicitar Confirmación<br/>al Cliente/]
    
    SolicitarConfirmacion --> ClienteConfirma{¿Cliente<br/>Confirma?}
    
    ClienteConfirma -->|No| CancelarTransaccion[Cancelar Transacción]
    CancelarTransaccion --> MostrarMenu
    
    ClienteConfirma -->|Sí| VerificarBilletes[Verificar Disponibilidad<br/>de Billetes]
    
    VerificarBilletes --> BilletesDisponibles{¿Hay Billetes<br/>Suficientes?}
    
    BilletesDisponibles -->|No| ErrorSinBilletes[❌ Error:<br/>Cajero Sin Efectivo]
    ErrorSinBilletes --> DisculparCliente[Disculparse con Cliente]
    DisculparCliente --> MostrarMenu
    
    BilletesDisponibles -->|Sí| ActualizarBD[(Actualizar Saldo<br/>en Base de Datos)]
    
    ActualizarBD --> RegistrarRetiro[(Registrar Retiro<br/>en Log Diario)]
    
    RegistrarRetiro --> DispensarDinero[💵 Dispensar Billetes]
    
    DispensarDinero --> AbrirBandeja[Abrir Bandeja<br/>de Entrega]
    
    AbrirBandeja --> EsperarRetiro[⏳ Esperar a que Cliente<br/>Retire Efectivo]
    
    EsperarRetiro --> VerificarRetiro{¿Cliente<br/>Retiró Dinero?}
    
    VerificarRetiro -->|No| AlertaSonora[🔔 Emitir Alerta<br/>Sonora]
    AlertaSonora --> Timeout{¿Timeout<br/>Excedido?}
    Timeout -->|No| EsperarRetiro
    Timeout -->|Sí| RetraerBilletes[Retraer Billetes<br/>no Retirados]
    RetraerBilletes --> RevertirTransaccion[Revertir Transacción<br/>en Base de Datos]
    RevertirTransaccion --> MostrarMenu
    
    VerificarRetiro -->|Sí| PreguntarRecibo{¿Desea<br/>Recibo?}
    
    PreguntarRecibo -->|Sí| ImprimirRecibo[🖨️ Imprimir Recibo]
    ImprimirRecibo --> EntregarRecibo[Entregar Recibo]
    EntregarRecibo --> PreguntarMas
    
    PreguntarRecibo -->|No| PreguntarMas{¿Desea Otra<br/>Operación?}
    
    PreguntarMas -->|Sí| MostrarMenu
    PreguntarMas -->|No| FinalizarSesion
    
    %% OTROS FLUJOS (simplificados)
    IniciarDeposito --> ProcesarDeposito[📦 Procesar Depósito<br/>Ver Subproceso]
    ProcesarDeposito --> PreguntarMas
    
    IniciarConsulta --> ProcesarConsulta[📈 Procesar Consulta<br/>Ver Subproceso]
    ProcesarConsulta --> PreguntarMas
    
    IniciarCompra --> ProcesarCompra[🎭 Procesar Compra<br/>Ver Subproceso]
    ProcesarCompra --> PreguntarMas
    
    %% FINALIZACIÓN
    FinalizarSesion --> ImprimirResumen[Imprimir Resumen<br/>de Sesión]
    
    ImprimirResumen --> ExpulsarTarjeta[Expulsar Tarjeta]
    
    ExpulsarTarjeta --> MensajeDespedida[Mostrar Mensaje:<br/>'Gracias por usar<br/>nuestros servicios']
    
    MensajeDespedida --> RegistrarLogFinal[(Registrar Log<br/>de Sesión)]
    
    RegistrarLogFinal --> LimpiarPantalla[Limpiar Pantalla]
    
    LimpiarPantalla --> FinNormal([✅ Fin])
    
    %% Estilos
    classDef startEnd fill:#90EE90,stroke:#006400,stroke-width:3px,color:#000
    classDef process fill:#87CEEB,stroke:#4682B4,stroke-width:2px,color:#000
    classDef decision fill:#FFD700,stroke:#FF8C00,stroke-width:2px,color:#000
    classDef error fill:#FFB6C1,stroke:#DC143C,stroke-width:2px,color:#000
    classDef database fill:#E6E6FA,stroke:#9370DB,stroke-width:2px,color:#000
    classDef input fill:#FFDAB9,stroke:#CD853F,stroke-width:2px,color:#000
    
    class Start,Fin1,Fin2,FinNormal startEnd
    class LeerTarjeta,SolicitarPassword,MostrarMenu,IniciarRetiro,MostrarOpciones,ConsultarSaldo,ConsultarLimite,CalcularDisponible,MostrarResumen,VerificarBilletes,DispensarDinero,AbrirBandeja,ImprimirRecibo,EntregarRecibo,FinalizarSesion,ImprimirResumen,ExpulsarTarjeta,MensajeDespedida,LimpiarPantalla,MostrarCuentas,ProcesarDeposito,ProcesarConsulta,ProcesarCompra,EsperarRetiro,AlertaSonora,RetraerBilletes,DisculparCliente process
    class ValidarTarjeta,ValidarPassword,VerificarIntentos,SeleccionarOperacion,VerificarCuentas,ValidarMonto,VerificarSaldo,VerificarLimite,ClienteConfirma,BilletesDisponibles,VerificarRetiro,PreguntarRecibo,PreguntarMas,OpcionReintentar,Timeout decision
    class MostrarErrorTarjeta,MostrarErrorPass,InvalidarTarjeta,RetenerTarjeta,ErrorSaldoInsuficiente,ErrorLimiteExcedido,ErrorMontoInvalido,CancelarTransaccion,ErrorSinBilletes,RevertirTransaccion error
    class ActualizarBD,RegistrarRetiro,RegistrarLogFinal database
    class InsertarTarjeta,IngresarPassword,SeleccionarCuenta,SeleccionarMonto,SolicitarConfirmacion input
